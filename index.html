<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zebbas Spel</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center py-10 px-4">
    
    <h1 class="text-3xl font-black italic uppercase text-indigo-500 mb-8 tracking-tighter">Mattias lir</h1>

    <div class="w-full max-w-sm bg-gray-800 p-6 rounded-3xl shadow-2xl border border-gray-700">
        <select id="playerCount" class="w-full bg-gray-900 border-2 border-gray-700 rounded-2xl p-4 font-bold text-center text-xl mb-4 focus:border-indigo-500 outline-none">
            <option value="1">1 Spelare</option>
            <option value="2" selected>2 Spelare</option>
            <option value="3">3 Spelare</option>
            <option value="4">4 Spelare</option>
            <option value="5">5 Spelare</option>
            <option value="6">6+ Spelare</option>
        </select>
        <button id="fetchBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black uppercase tracking-widest transition-all">Sök i samlingen</button>
    </div>

    <div id="status" class="mt-6 text-sm text-gray-400 text-center max-w-xs leading-relaxed"></div>
    
    <div id="gameGrid" class="mt-8 w-full max-w-md space-y-3"></div>

    <script>
        const USERNAME = 'zebbas';
        
        // Vi testar en annan proxy-metod som är mer "aggressiv"
        const PROXY = "https://corsproxy.io/?";

        document.getElementById('fetchBtn').addEventListener('click', async () => {
            const count = parseInt(document.getElementById('playerCount').value);
            const status = document.getElementById('status');
            const grid = document.getElementById('gameGrid');
            const btn = document.getElementById('fetchBtn');

            grid.innerHTML = "";
            btn.disabled = true;
            status.innerHTML = "Hämtar data...<br>(Om detta tar mer än 10 sek, har BGG låst sig)";

            const bggUrl = `https://boardgamegeek.com/xmlapi2/collection?username=${USERNAME}&own=1&excludesubtype=boardgameexpansion&stats=1`;
            
            try {
                const response = await fetch(PROXY + encodeURIComponent(bggUrl));
                
                if (!response.ok) throw new Error();

                const text = await response.text();
                
                if (text.includes('message')) {
                    status.innerHTML = "BGG förbereder listan. <br><br> <a href='" + bggUrl + "' target='_blank' class='text-indigo-400 underline font-bold'>KLICKA HÄR FÖR ATT VÄCKA BGG</a><br><br>Kom sen tillbaka hit och tryck på knappen igen.";
                    btn.disabled = false;
                    return;
                }

                const xml = new DOMParser().parseFromString(text, "text/xml");
                const items = Array.from(xml.querySelectorAll('item'));

                if (items.length === 0) {
                    status.innerText = "Hittade inga spel. Testa igen om en stund.";
                    btn.disabled = false;
                    return;
                }

                const filtered = items.filter(item => {
                    const stats = item.querySelector('stats');
                    const min = parseInt(stats.getAttribute('minplayers'));
                    const max = parseInt(stats.getAttribute('maxplayers'));
                    return count >= min && count <= max;
                }).sort((a, b) => {
                    const rA = parseFloat(a.querySelector('stats rating average').getAttribute('value'));
                    const rB = parseFloat(b.querySelector('stats rating average').getAttribute('value'));
                    return rB - rA;
                });

                status.innerText = `Visar ${filtered.length} spel för ${count} personer:`;

                grid.innerHTML = filtered.map(game => `
                    <div class="bg-gray-800 p-4 rounded-2xl flex items-center gap-4 border border-gray-700 shadow-lg">
                        <img src="${game.querySelector('thumbnail')?.textContent}" class="w-14 h-14 object-cover rounded-lg">
                        <div class="flex-grow">
                            <h3 class="font-bold text-gray-100 text-sm leading-tight">${game.querySelector('name').textContent}</h3>
                            <p class="text-[10px] font-bold text-indigo-400 mt-1 uppercase">Betyg: ${parseFloat(game.querySelector('stats rating average').getAttribute('value')).toFixed(1)}</p>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                status.innerHTML = "Anslutningen misslyckades. <br><br> Prova att <a href='" + bggUrl + "' target='_blank' class='text-indigo-400 underline font-bold text-lg italic'>ÖPPNA DENNA LÄNK</a>, stäng den fliken, och tryck på sök igen.";
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
