<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zebbas Spelhylla</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">
    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black mb-2 text-indigo-900 tracking-tight uppercase italic">Zebbas Games</h1>
            <div class="h-1 w-20 bg-indigo-500 mx-auto"></div>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100 mb-8 max-w-md mx-auto">
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2 tracking-widest text-center">Antal spelare</label>
                    <select id="playerCount" class="w-full border-2 border-slate-100 rounded-2xl p-4 bg-slate-50 font-bold focus:border-indigo-500 outline-none text-xl">
                        <option value="1">1 Person</option>
                        <option value="2" selected>2 Personer</option>
                        <option value="3">3 Personer</option>
                        <option value="4">4 Personer</option>
                        <option value="5">5 Personer</option>
                        <option value="6">6+ Personer</option>
                    </select>
                </div>
                <button id="fetchBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl hover:bg-indigo-700 font-black shadow-lg shadow-indigo-200 transition-all active:scale-95 uppercase">
                    Hitta Spel
                </button>
            </div>
        </div>

        <div id="status" class="text-center mb-6 font-medium text-slate-500 text-sm italic">Redo att h√§mta spel...</div>
        <div id="gameGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>

    <script>
        const USERNAME = 'zebbas';
        const PROXY = "https://corsproxy.io/?";

        async function fetchBGG(url) {
            try {
                const response = await fetch(PROXY + encodeURIComponent(url));
                if (response.status === 202) return "queued";
                if (!response.ok) return null;
                const text = await response.text();
                return new DOMParser().parseFromString(text, "text/xml");
            } catch (e) {
                return null;
            }
        }

        document.getElementById('fetchBtn').addEventListener('click', async () => {
            const count = document.getElementById('playerCount').value;
            const status = document.getElementById('status');
            const grid = document.getElementById('gameGrid');
            const btn = document.getElementById('fetchBtn');

            grid.innerHTML = "";
            btn.disabled = true;
            status.innerText = "Kontaktar BGG... (Detta kan ta upp till 30 sekunder)";

            try {
                // Steg 1: H√§mta samlingen
                const collectionUrl = `https://boardgamegeek.com/xmlapi2/collection?username=${USERNAME}&own=1&excludesubtype=boardgameexpansion&stats=1`;
                let xml = await fetchBGG(collectionUrl);

                // Hantera BGG-k√∂
                let retries = 0;
                while ((xml === "queued" || !xml || xml.querySelector('message')) && retries < 6) {
                    retries++;
                    status.innerText = `BGG f√∂rbereder din lista... f√∂rs√∂k ${retries}/6`;
                    await new Promise(r => setTimeout(r, 5000));
                    xml = await fetchBGG(collectionUrl);
                }

                const items = Array.from(xml.querySelectorAll('item'));
                if (items.length === 0) throw new Error("Kunde inte ladda samlingen.");

                status.innerText = `Hittade ${items.length} spel. Analyserar spelarantal...`;

                // Steg 2: H√§mta detaljer (vi g√∂r detta i klumpar om 20 f√∂r att undvika timeout)
                const ids = items.map(i => i.getAttribute('objectid'));
                const finalGames = [];
                
                // Vi g√∂r ett samlat anrop f√∂r detaljer
                const detailsXml = await fetchBGG(`https://boardgamegeek.com/xmlapi2/thing?id=${ids.join(',')}&stats=1`);
                if (!detailsXml) throw new Error("Kunde inte h√§mta speldetaljer.");

                const gamesData = detailsXml.querySelectorAll('item');

                gamesData.forEach(game => {
                    const id = game.getAttribute('id');
                    const title = game.querySelector('name[type="primary"]')?.getAttribute('value') || "Ok√§nd titel";
                    const thumb = game.querySelector('thumbnail')?.textContent || '';
                    
                    const colItem = items.find(i => i.getAttribute('objectid') === id);
                    const myRating = colItem?.querySelector('stats rating')?.getAttribute('value');
                    const avgRating = colItem?.querySelector('stats rating average')?.getAttribute('value');

                    // H√§mta r√∂stning f√∂r spelarantal
                    const poll = game.querySelector('poll[name="suggested_numplayers"]');
                    const results = poll?.querySelector(`results[numplayers="${count}"]`) || 
                                    poll?.querySelector(`results[numplayers="${count}+"]`);

                    if (results) {
                        const best = parseInt(results.querySelector('result[value="Best"]').getAttribute('numvotes')) || 0;
                        const rec = parseInt(results.querySelector('result[value="Recommended"]').getAttribute('numvotes')) || 0;
                        const notRec = parseInt(results.querySelector('result[value="Not Recommended"]').getAttribute('numvotes')) || 0;

                        if ((best + rec) > notRec) {
                            finalGames.push({
                                title, img: thumb,
                                myRating: (myRating && myRating !== "N/A") ? parseFloat(myRating).toFixed(1) : "-",
                                avgRating: parseFloat(avgRating).toFixed(1),
                                isBest: best >= rec && best > notRec,
                                sortScore: parseFloat(avgRating)
                            });
                        }
                    }
                });

                finalGames.sort((a, b) => b.sortScore - a.sortScore);
                
                if (finalGames.length === 0) {
                    status.innerText = "Inga spel matchade filtreringen.";
                } else {
                    status.innerText = `Klart! Hittade ${finalGames.length} spel.`;
                    grid.innerHTML = finalGames.map(game => `
                        <div class="bg-white rounded-2xl overflow-hidden shadow-md border border-slate-100 flex flex-col h-full">
                            <div class="relative h-40 bg-slate-100">
                                <img src="${game.img}" class="w-full h-full object-cover">
                                <span class="absolute top-2 right-2 ${game.isBest ? 'bg-amber-400' : 'bg-indigo-500 text-white'} text-[10px] font-bold px-2 py-1 rounded-md shadow-sm">
                                    ${game.isBest ? '‚≠ê B√ÑST' : 'üëç REK.'}
                                </span>
                            </div>
                            <div class="p-4 flex-grow flex flex-col justify-between">
                                <h3 class="font-bold text-slate-800 text-sm leading-tight mb-4">${game.title}</h3>
                                <div class="flex justify-between border-t pt-3">
                                    <div class="text-center"><p class="text-[9px] text-slate-400 uppercase font-bold text-[8px]">Mig</p><p class="text-md font-black text-indigo-600">${game.myRating}</p></div>
                                    <div class="text-center"><p class="text-[9px] text-slate-400 uppercase font-bold text-[8px]">BGG</p><p class="text-md font-black text-slate-700">${game.avgRating}</p></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (err) {
                status.innerText = "BGG svarade inte i tid. V√§nta 10 sekunder och prova igen.";
                console.error(err);
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
